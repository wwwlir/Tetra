<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0//EN" "http://www.w3.org/TR/REC-html40/strict.dtd">
<html><head><meta name="qrichtext" content="1" /><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><style type="text/css">
p, li { white-space: pre-wrap; }
</style></head><body style=" font-family:'DejaVu Sans'; font-size:11pt; font-weight:400; font-style:normal;">
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Пример использования <span style=" font-family:'monospace';">EntityManager</span> в <a href="https://doc.cuba-platform.com/manual-6.10-ru/services.html"><span style=" text-decoration: underline; color:#0000ff;">сервисе</span></a>: </p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">@Service(SalesService.NAME)</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">public class SalesServiceBean implements SalesService {</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'FreeMono'; color:#6a1009;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">    @Inject</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">    private Persistence persistence;</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'FreeMono'; color:#6a1009;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">    @Override</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">    public BigDecimal calculateSales(UUID customerId) {</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">        BigDecimal result;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">        // start transaction</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">        try (Transaction tx = persistence.createTransaction()) {</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">            // get EntityManager for the current transaction</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">            EntityManager em = persistence.getEntityManager();</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">            // create and execute Query</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">            Query query = em.createQuery(</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">                    &quot;select sum(o.amount) from sample$Order o where o.customer.id = :customerId&quot;);</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">            query.setParameter(&quot;customerId&quot;, customerId);</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">            result = (BigDecimal) query.getFirstResult();</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">            // commit transaction</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">            tx.commit();</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">        }</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">        return result != null ? result : BigDecimal.ZERO;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">    }</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'FreeMono'; color:#6a1009;">} </span></p>
<p style=" margin-top:8px; margin-bottom:8px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="em_partial_entities"></a>Частичные сущности </p>
<p style="-qt-paragraph-type:empty; margin-top:8px; margin-bottom:8px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></p>
<p style=" margin-top:8px; margin-bottom:8px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'DejaVu Sans Mono'; color:#a9b7c6; background-color:#2b2b2b;">Persistence persistence = AppBeans.</span><span style=" font-family:'DejaVu Sans Mono'; font-style:italic; color:#a9b7c6;">get</span><span style=" font-family:'DejaVu Sans Mono'; color:#a9b7c6;">(Persistence.</span><span style=" font-family:'DejaVu Sans Mono'; color:#cc7832;">class</span><span style=" font-family:'DejaVu Sans Mono'; color:#a9b7c6;">)</span><span style=" font-family:'DejaVu Sans Mono'; color:#cc7832;">;<br /></span><span style=" font-family:'DejaVu Sans Mono'; color:#a9b7c6;">BigDecimal result = </span><span style=" font-family:'DejaVu Sans Mono'; color:#cc7832;">null;<br />    try </span><span style=" font-family:'DejaVu Sans Mono'; color:#a9b7c6;">(Transaction tx = persistence.createTransaction()) {<br />        </span><span style=" font-family:'DejaVu Sans Mono'; color:#808080;">// get EntityManager for the current transaction<br />        </span><span style=" font-family:'DejaVu Sans Mono'; color:#a9b7c6;">EntityManager em = persistence.getEntityManager()</span><span style=" font-family:'DejaVu Sans Mono'; color:#cc7832;">;<br />        </span><span style=" font-family:'DejaVu Sans Mono'; color:#808080;">// create and execute Query<br />        </span><span style=" font-family:'DejaVu Sans Mono'; color:#a9b7c6;">Query query = em.createQuery(</span><span style=" font-family:'DejaVu Sans Mono'; color:#6a8759;">&quot;select count(p) from rtneo$Payment p where p.inn = :inn&quot;</span><span style=" font-family:'DejaVu Sans Mono'; color:#a9b7c6;">)</span><span style=" font-family:'DejaVu Sans Mono'; color:#cc7832;">;<br />        </span><span style=" font-family:'DejaVu Sans Mono'; color:#a9b7c6;">query.setParameter(</span><span style=" font-family:'DejaVu Sans Mono'; color:#6a8759;">&quot;inn&quot;</span><span style=" font-family:'DejaVu Sans Mono'; color:#cc7832;">, </span><span style=" font-family:'DejaVu Sans Mono'; color:#9876aa;">contract</span><span style=" font-family:'DejaVu Sans Mono'; color:#a9b7c6;">.getContragent().getInn())</span><span style=" font-family:'DejaVu Sans Mono'; color:#cc7832;">;<br />        </span><span style=" font-family:'DejaVu Sans Mono'; color:#a9b7c6;">result = (BigDecimal) query.getFirstResult()</span><span style=" font-family:'DejaVu Sans Mono'; color:#cc7832;">;<br />        </span><span style=" font-family:'DejaVu Sans Mono'; color:#808080;">// commit transaction<br />        </span><span style=" font-family:'DejaVu Sans Mono'; color:#a9b7c6;">tx.commit()</span><span style=" font-family:'DejaVu Sans Mono'; color:#cc7832;">;<br />    </span><span style=" font-family:'DejaVu Sans Mono'; color:#a9b7c6;">}<br />    </span><span style=" font-family:'DejaVu Sans Mono'; color:#cc7832;">return </span><span style=" font-family:'DejaVu Sans Mono'; color:#a9b7c6;">result != </span><span style=" font-family:'DejaVu Sans Mono'; color:#cc7832;">null </span><span style=" font-family:'DejaVu Sans Mono'; color:#a9b7c6;">? result : BigDecimal.</span><span style=" font-family:'DejaVu Sans Mono'; font-style:italic; color:#9876aa;">ZERO</span><span style=" font-family:'DejaVu Sans Mono'; color:#cc7832;">;</span></p></body></html>