<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0//EN" "http://www.w3.org/TR/REC-html40/strict.dtd">
<html><head><meta name="qrichtext" content="1" /><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><style type="text/css">
p, li { white-space: pre-wrap; }
</style></head><body style=" font-family:'DejaVu Sans'; font-size:11pt; font-weight:400; font-style:normal;">
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#2b2b2b;"><span style=" font-family:'DejaVu Sans Mono'; color:#cc7832;">import </span><span style=" font-family:'DejaVu Sans Mono'; color:#a9b7c6;">com.haulmont.cuba.core.global.*<br /></span><span style=" font-family:'DejaVu Sans Mono'; color:#cc7832;">import </span><span style=" font-family:'DejaVu Sans Mono'; color:#a9b7c6;">com.groupstp.rtneo.entity.*<br /></span><span style=" font-family:'DejaVu Sans Mono'; color:#cc7832;">import </span><span style=" font-family:'DejaVu Sans Mono'; color:#a9b7c6;">com.groupstp.rtneo.core.bean.tools.DatePeriodTools<br /></span><span style=" font-family:'DejaVu Sans Mono'; color:#cc7832;">import </span><span style=" font-family:'DejaVu Sans Mono'; color:#a9b7c6;">java.text.SimpleDateFormat<br /></span><span style=" font-family:'DejaVu Sans Mono'; color:#cc7832;">import </span><span style=" font-family:'DejaVu Sans Mono'; color:#a9b7c6;">com.groupstp.rtneo.core.bean.calculation.CalculationWorkerHelper<br /></span><span style=" font-family:'DejaVu Sans Mono'; color:#cc7832;">import </span><span style=" font-family:'DejaVu Sans Mono'; color:#a9b7c6;">java.util.*<br /></span><span style=" font-family:'DejaVu Sans Mono'; color:#cc7832;">import </span><span style=" font-family:'DejaVu Sans Mono'; color:#a9b7c6;">com.haulmont.cuba.core.global.ViewRepository;<br />log.debug(</span><span style=" font-family:'DejaVu Sans Mono'; color:#6a8759;">&quot;createSupplementaryAggrements.START&quot;</span><span style=" font-family:'DejaVu Sans Mono'; color:#a9b7c6;">)<br /><br /></span><span style=" font-family:'DejaVu Sans Mono'; color:#808080;">//a.kotvinskiy /--<br />//Программное создание view<br /></span><span style=" font-family:'DejaVu Sans Mono'; color:#a9b7c6;">ViewRepository vRep = AppBeans.get(ViewRepository.NAME)<br /><br />View contractView = vRep.getView(Contract.</span><span style=" font-family:'DejaVu Sans Mono'; color:#cc7832;">class</span><span style=" font-family:'DejaVu Sans Mono'; color:#a9b7c6;">, </span><span style=" font-family:'DejaVu Sans Mono'; color:#6a8759;">&quot;_minimal&quot;</span><span style=" font-family:'DejaVu Sans Mono'; color:#a9b7c6;">);<br />contractView.addProperty(</span><span style=" font-family:'DejaVu Sans Mono'; color:#6a8759;">&quot;number&quot;</span><span style=" font-family:'DejaVu Sans Mono'; color:#a9b7c6;">);<br />contractView.addProperty(</span><span style=" font-family:'DejaVu Sans Mono'; color:#6a8759;">&quot;contragent&quot;</span><span style=" font-family:'DejaVu Sans Mono'; color:#a9b7c6;">, vRep.getView(Contragent.</span><span style=" font-family:'DejaVu Sans Mono'; color:#cc7832;">class</span><span style=" font-family:'DejaVu Sans Mono'; color:#a9b7c6;">, </span><span style=" font-family:'DejaVu Sans Mono'; color:#6a8759;">&quot;_minimal&quot;</span><span style=" font-family:'DejaVu Sans Mono'; color:#a9b7c6;">));<br />contractView.addProperty(</span><span style=" font-family:'DejaVu Sans Mono'; color:#6a8759;">&quot;positions&quot;</span><span style=" font-family:'DejaVu Sans Mono'; color:#a9b7c6;">, vRep.getView(ContractPosition.</span><span style=" font-family:'DejaVu Sans Mono'; color:#cc7832;">class</span><span style=" font-family:'DejaVu Sans Mono'; color:#a9b7c6;">, </span><span style=" font-family:'DejaVu Sans Mono'; color:#6a8759;">&quot;_minimal&quot;</span><span style=" font-family:'DejaVu Sans Mono'; color:#a9b7c6;">));<br />contractView.addProperty(</span><span style=" font-family:'DejaVu Sans Mono'; color:#6a8759;">&quot;supplementaryAgreements&quot;</span><span style=" font-family:'DejaVu Sans Mono'; color:#a9b7c6;">, vRep.getView(Contract.</span><span style=" font-family:'DejaVu Sans Mono'; color:#cc7832;">class</span><span style=" font-family:'DejaVu Sans Mono'; color:#a9b7c6;">, </span><span style=" font-family:'DejaVu Sans Mono'; color:#6a8759;">&quot;_minimal&quot;</span><span style=" font-family:'DejaVu Sans Mono'; color:#a9b7c6;">));<br /><br />View contractPositionView = vRep.getView(ContractPosition.</span><span style=" font-family:'DejaVu Sans Mono'; color:#cc7832;">class</span><span style=" font-family:'DejaVu Sans Mono'; color:#a9b7c6;">, </span><span style=" font-family:'DejaVu Sans Mono'; color:#6a8759;">&quot;_minimal&quot;</span><span style=" font-family:'DejaVu Sans Mono'; color:#a9b7c6;">);<br />contractPositionView.addProperty(</span><span style=" font-family:'DejaVu Sans Mono'; color:#6a8759;">&quot;relevance&quot;</span><span style=" font-family:'DejaVu Sans Mono'; color:#a9b7c6;">);<br />contractPositionView.addProperty(</span><span style=" font-family:'DejaVu Sans Mono'; color:#6a8759;">&quot;volumeYear&quot;</span><span style=" font-family:'DejaVu Sans Mono'; color:#a9b7c6;">);<br />contractPositionView.addProperty(</span><span style=" font-family:'DejaVu Sans Mono'; color:#6a8759;">&quot;accruals&quot;</span><span style=" font-family:'DejaVu Sans Mono'; color:#a9b7c6;">, vRep.getView(Accrual.</span><span style=" font-family:'DejaVu Sans Mono'; color:#cc7832;">class</span><span style=" font-family:'DejaVu Sans Mono'; color:#a9b7c6;">, </span><span style=" font-family:'DejaVu Sans Mono'; color:#6a8759;">&quot;_minimal&quot;</span><span style=" font-family:'DejaVu Sans Mono'; color:#a9b7c6;">));<br /></span><span style=" font-family:'DejaVu Sans Mono'; color:#808080;">//a.kotvinskiy --/<br /><br />//здесь, в переменную price нужно указать тариф, тестовое значение = 500<br /></span><span style=" font-family:'DejaVu Sans Mono'; color:#a9b7c6;">BigDecimal price = </span><span style=" font-family:'DejaVu Sans Mono'; color:#6897bb;">464.8<br /></span><span style=" font-family:'DejaVu Sans Mono'; color:#808080;">//Если contractId &quot;&quot;, то доп генерируется для всех<br /></span><span style=" font-family:'DejaVu Sans Mono'; color:#a9b7c6;">String contractId = </span><span style=" font-family:'DejaVu Sans Mono'; color:#6a8759;">&quot;ad8531cf-55a2-36fb-393f-9542097a08b0&quot;<br /><br /></span><span style=" font-family:'DejaVu Sans Mono'; color:#a9b7c6;">SimpleDateFormat format = </span><span style=" font-family:'DejaVu Sans Mono'; color:#cc7832;">new </span><span style=" font-family:'DejaVu Sans Mono'; color:#a9b7c6;">SimpleDateFormat(</span><span style=" font-family:'DejaVu Sans Mono'; color:#6a8759;">&quot;dd.MM.yyyy&quot;</span><span style=" font-family:'DejaVu Sans Mono'; color:#a9b7c6;">)<br />Date fromDate = format.parse(</span><span style=" font-family:'DejaVu Sans Mono'; color:#6a8759;">&quot;01.07.2019&quot;</span><span style=" font-family:'DejaVu Sans Mono'; color:#a9b7c6;">)<br />Date beforeDate = format.parse(</span><span style=" font-family:'DejaVu Sans Mono'; color:#6a8759;">&quot;31.12.2019&quot;</span><span style=" font-family:'DejaVu Sans Mono'; color:#a9b7c6;">)<br />Date contract_date = format.parse(</span><span style=" font-family:'DejaVu Sans Mono'; color:#6a8759;">&quot;01.07.2019&quot;</span><span style=" font-family:'DejaVu Sans Mono'; color:#a9b7c6;">)<br /><br />DataManager dataManager = AppBeans.get(DataManager.NAME)<br />Metadata metadata = AppBeans.get(Metadata.NAME)<br /><br />String tableNameCompany = metadata.getClassNN(Company.</span><span style=" font-family:'DejaVu Sans Mono'; color:#cc7832;">class</span><span style=" font-family:'DejaVu Sans Mono'; color:#a9b7c6;">).getName()<br />String tableNameContract = metadata.getClassNN(Contract.</span><span style=" font-family:'DejaVu Sans Mono'; color:#cc7832;">class</span><span style=" font-family:'DejaVu Sans Mono'; color:#a9b7c6;">).getName()<br /><br />CommitContext commitContext = </span><span style=" font-family:'DejaVu Sans Mono'; color:#cc7832;">new </span><span style=" font-family:'DejaVu Sans Mono'; color:#a9b7c6;">CommitContext()<br /><br />List&lt;Company&gt; listCompany = dataManager.load(Company.</span><span style=" font-family:'DejaVu Sans Mono'; color:#cc7832;">class</span><span style=" font-family:'DejaVu Sans Mono'; color:#a9b7c6;">)<br />        .query(</span><span style=" font-family:'DejaVu Sans Mono'; color:#6a8759;">&quot;select comp from &quot; </span><span style=" font-family:'DejaVu Sans Mono'; color:#a9b7c6;">+ tableNameCompany + </span><span style=" font-family:'DejaVu Sans Mono'; color:#6a8759;">&quot; comp&quot;</span><span style=" font-family:'DejaVu Sans Mono'; color:#a9b7c6;">)<br />        .view(</span><span style=" font-family:'DejaVu Sans Mono'; color:#6a8759;">&quot;_minimal&quot;</span><span style=" font-family:'DejaVu Sans Mono'; color:#a9b7c6;">)<br />        .list()<br />Company company = listCompany.size() == </span><span style=" font-family:'DejaVu Sans Mono'; color:#6897bb;">1 </span><span style=" font-family:'DejaVu Sans Mono'; color:#a9b7c6;">? listCompany.get(</span><span style=" font-family:'DejaVu Sans Mono'; color:#6897bb;">0</span><span style=" font-family:'DejaVu Sans Mono'; color:#a9b7c6;">) : </span><span style=" font-family:'DejaVu Sans Mono'; color:#cc7832;">null<br /><br /></span><span style=" font-family:'DejaVu Sans Mono'; color:#a9b7c6;">List&lt;Contract&gt; list = dataManager.load(Contract.</span><span style=" font-family:'DejaVu Sans Mono'; color:#cc7832;">class</span><span style=" font-family:'DejaVu Sans Mono'; color:#a9b7c6;">)<br />        .query(</span><span style=" font-family:'DejaVu Sans Mono'; color:#6a8759;">&quot;select c from &quot; </span><span style=" font-family:'DejaVu Sans Mono'; color:#a9b7c6;">+ tableNameContract + </span><span style=" font-family:'DejaVu Sans Mono'; color:#6a8759;">&quot; c where c.loadedFromBigTrio = true&quot; </span><span style=" font-family:'DejaVu Sans Mono'; color:#a9b7c6;">+ </span><span style=" font-family:'DejaVu Sans Mono'; color:#cc7832;">new </span><span style=" font-family:'DejaVu Sans Mono'; color:#a9b7c6;">StringBuilder(contractId != </span><span style=" font-family:'DejaVu Sans Mono'; color:#6a8759;">&quot;&quot; </span><span style=" font-family:'DejaVu Sans Mono'; color:#a9b7c6;">? </span><span style=" font-family:'DejaVu Sans Mono'; color:#6a8759;">&quot; and c.id = '</span><span style=" font-family:'DejaVu Sans Mono'; color:#a9b7c6;">${contractId}</span><span style=" font-family:'DejaVu Sans Mono'; color:#6a8759;">'&quot; </span><span style=" font-family:'DejaVu Sans Mono'; color:#a9b7c6;">: </span><span style=" font-family:'DejaVu Sans Mono'; color:#6a8759;">&quot;&quot;</span><span style=" font-family:'DejaVu Sans Mono'; color:#a9b7c6;">).toString())<br />        .view(contractView)<br />        .list()<br /><br />log.debug(</span><span style=" font-family:'DejaVu Sans Mono'; color:#6a8759;">&quot;Будет обработано &quot; </span><span style=" font-family:'DejaVu Sans Mono'; color:#a9b7c6;">+ list.size() + </span><span style=" font-family:'DejaVu Sans Mono'; color:#6a8759;">&quot; договоров, загруженных из BigTrio&quot;</span><span style=" font-family:'DejaVu Sans Mono'; color:#a9b7c6;">)<br /><br /></span><span style=" font-family:'DejaVu Sans Mono'; color:#cc7832;">def </span><span style=" font-family:'DejaVu Sans Mono'; color:#a9b7c6;">numContract = </span><span style=" font-family:'DejaVu Sans Mono'; color:#6897bb;">0<br /></span><span style=" font-family:'DejaVu Sans Mono'; color:#cc7832;">def </span><span style=" font-family:'DejaVu Sans Mono'; color:#a9b7c6;">numContractPosition = </span><span style=" font-family:'DejaVu Sans Mono'; color:#6897bb;">0<br /></span><span style=" font-family:'DejaVu Sans Mono'; color:#cc7832;">def </span><span style=" font-family:'DejaVu Sans Mono'; color:#a9b7c6;">numAccrual = </span><span style=" font-family:'DejaVu Sans Mono'; color:#6897bb;">0<br /></span><span style=" font-family:'DejaVu Sans Mono'; color:#cc7832;">for </span><span style=" font-family:'DejaVu Sans Mono'; color:#a9b7c6;">(Contract baseContract : list) {<br />    </span><span style=" font-family:'DejaVu Sans Mono'; color:#808080;">//if (numContract == 1)<br />    //    break<br />    </span><span style=" font-family:'DejaVu Sans Mono'; color:#a9b7c6;">log.debug((numContract + </span><span style=" font-family:'DejaVu Sans Mono'; color:#6897bb;">1</span><span style=" font-family:'DejaVu Sans Mono'; color:#a9b7c6;">) + </span><span style=" font-family:'DejaVu Sans Mono'; color:#6a8759;">&quot;) Договор № &quot; </span><span style=" font-family:'DejaVu Sans Mono'; color:#a9b7c6;">+ baseContract.getNumber())<br />    Contragent contragent = baseContract.getContragent()<br /><br />    Contract contract = </span><span style=" font-family:'DejaVu Sans Mono'; color:#cc7832;">new </span><span style=" font-family:'DejaVu Sans Mono'; color:#a9b7c6;">Contract()<br />    contract.setDate(</span><span style=" font-family:'DejaVu Sans Mono'; color:#cc7832;">new </span><span style=" font-family:'DejaVu Sans Mono'; color:#a9b7c6;">Date())<br />    contract.setFrom(fromDate)<br />    contract.setBefore(beforeDate)<br />    </span><span style=" font-family:'DejaVu Sans Mono'; color:#808080;">//a.kotvinskiy<br />    </span><span style=" font-family:'DejaVu Sans Mono'; color:#a9b7c6;">contract.setNumber(</span><span style=" font-family:'DejaVu Sans Mono'; color:#6a8759;">&quot;</span><span style=" font-family:'DejaVu Sans Mono'; color:#a9b7c6;">${baseContract.getSupplementaryAgreements().size()+</span><span style=" font-family:'DejaVu Sans Mono'; color:#6897bb;">1</span><span style=" font-family:'DejaVu Sans Mono'; color:#a9b7c6;">}</span><span style=" font-family:'DejaVu Sans Mono'; color:#6a8759;">&quot;</span><span style=" font-family:'DejaVu Sans Mono'; color:#a9b7c6;">)<br />    contract.setCompany(company)<br />    contract.setContragent(contragent)<br />    contract.setMainContract(baseContract)<br />    contract.setPositions(</span><span style=" font-family:'DejaVu Sans Mono'; color:#cc7832;">new </span><span style=" font-family:'DejaVu Sans Mono'; color:#a9b7c6;">ArrayList&lt;&gt;())<br />    commitContext.addInstanceToCommit(contract)<br />    log.debug(</span><span style=" font-family:'DejaVu Sans Mono'; color:#6a8759;">&quot;Доп. соглашение </span><span style=" font-family:'DejaVu Sans Mono'; color:#a9b7c6;">$contract.id</span><span style=" font-family:'DejaVu Sans Mono'; color:#6a8759;"> добавлено в CommitContext&quot;</span><span style=" font-family:'DejaVu Sans Mono'; color:#a9b7c6;">)<br />    numContract = numContract + </span><span style=" font-family:'DejaVu Sans Mono'; color:#6897bb;">1<br /><br />    </span><span style=" font-family:'DejaVu Sans Mono'; color:#808080;">//для каждой позиции в base-договоре<br />    </span><span style=" font-family:'DejaVu Sans Mono'; color:#cc7832;">for </span><span style=" font-family:'DejaVu Sans Mono'; color:#a9b7c6;">(ContractPosition baseContractPosition : baseContract.getPositions()) {<br />        baseContractPosition = dataManager.reload(baseContractPosition, contractPositionView)<br />        ContractPosition contractPosition = </span><span style=" font-family:'DejaVu Sans Mono'; color:#cc7832;">new </span><span style=" font-family:'DejaVu Sans Mono'; color:#a9b7c6;">ContractPosition()<br />        contractPosition.setVolumeYear(baseContractPosition.getVolumeYear())<br />        contractPosition.setPeriod(contract_date)<br />        contractPosition.setContract(contract)<br />        contractPosition.setRelevance(baseContractPosition.getRelevance())<br />        contractPosition.setContragent(contragent)<br />        contractPosition.setAccruals(</span><span style=" font-family:'DejaVu Sans Mono'; color:#cc7832;">new </span><span style=" font-family:'DejaVu Sans Mono'; color:#a9b7c6;">ArrayList&lt;&gt;())<br />        commitContext.addInstanceToCommit(contractPosition)<br />        log.debug(</span><span style=" font-family:'DejaVu Sans Mono'; color:#6a8759;">&quot;ContractPosition </span><span style=" font-family:'DejaVu Sans Mono'; color:#a9b7c6;">$contractPosition.id</span><span style=" font-family:'DejaVu Sans Mono'; color:#6a8759;"> добавлена в CommitContext&quot;</span><span style=" font-family:'DejaVu Sans Mono'; color:#a9b7c6;">)<br />        numContractPosition = numContractPosition + </span><span style=" font-family:'DejaVu Sans Mono'; color:#6897bb;">1<br />        </span><span style=" font-family:'DejaVu Sans Mono'; color:#a9b7c6;">contract.getPositions().add(contractPosition)<br /><br />        </span><span style=" font-family:'DejaVu Sans Mono'; color:#808080;">//расчет начислений<br />        </span><span style=" font-family:'DejaVu Sans Mono'; color:#a9b7c6;">List&lt;Accrual&gt; listAccruals = calculateAccruals(fromDate,<br />                beforeDate,<br />                </span><span style=" font-family:'DejaVu Sans Mono'; color:#cc7832;">new </span><span style=" font-family:'DejaVu Sans Mono'; color:#a9b7c6;">Date(),<br />                contractPosition,<br />                price)<br />        </span><span style=" font-family:'DejaVu Sans Mono'; color:#cc7832;">for </span><span style=" font-family:'DejaVu Sans Mono'; color:#a9b7c6;">(Accrual accrual:listAccruals)<br />        {<br />            commitContext.addInstanceToCommit(accrual)<br />            log.debug(</span><span style=" font-family:'DejaVu Sans Mono'; color:#6a8759;">&quot;Accrual </span><span style=" font-family:'DejaVu Sans Mono'; color:#a9b7c6;">$accrual.id</span><span style=" font-family:'DejaVu Sans Mono'; color:#6a8759;"> добавлена в CommitContext&quot;</span><span style=" font-family:'DejaVu Sans Mono'; color:#a9b7c6;">)<br />            numAccrual = numAccrual + </span><span style=" font-family:'DejaVu Sans Mono'; color:#6897bb;">1<br />            </span><span style=" font-family:'DejaVu Sans Mono'; color:#a9b7c6;">contractPosition.getAccruals().add(accrual)<br />        }<br />    }<br />    </span><span style=" font-family:'DejaVu Sans Mono'; color:#808080;">//делаем неактивным допик<br />    //makeContractObsolete(contract, false);<br />    //снова делаем активным последний договор<br />    //makeContractObsolete(lastContract, true);<br /></span><span style=" font-family:'DejaVu Sans Mono'; color:#a9b7c6;">}<br />log.debug(</span><span style=" font-family:'DejaVu Sans Mono'; color:#6a8759;">&quot;Запись изменений в БД...&quot;</span><span style=" font-family:'DejaVu Sans Mono'; color:#a9b7c6;">)<br />dataManager.commit(commitContext)<br />log.debug(</span><span style=" font-family:'DejaVu Sans Mono'; color:#6a8759;">&quot;Всего создано:</span><span style=" font-family:'DejaVu Sans Mono'; color:#cc7832;">\n</span><span style=" font-family:'DejaVu Sans Mono'; color:#6a8759;">Доп.соглашений: &quot; </span><span style=" font-family:'DejaVu Sans Mono'; color:#a9b7c6;">+ numContract + </span><span style=" font-family:'DejaVu Sans Mono'; color:#6a8759;">&quot;</span><span style=" font-family:'DejaVu Sans Mono'; color:#cc7832;">\n</span><span style=" font-family:'DejaVu Sans Mono'; color:#6a8759;">ContractPosition: &quot; </span><span style=" font-family:'DejaVu Sans Mono'; color:#a9b7c6;">+ numContractPosition + </span><span style=" font-family:'DejaVu Sans Mono'; color:#6a8759;">&quot;</span><span style=" font-family:'DejaVu Sans Mono'; color:#cc7832;">\n</span><span style=" font-family:'DejaVu Sans Mono'; color:#6a8759;">Accruals: &quot; </span><span style=" font-family:'DejaVu Sans Mono'; color:#a9b7c6;">+ numAccrual)<br />log.debug(</span><span style=" font-family:'DejaVu Sans Mono'; color:#6a8759;">&quot;createSupplementaryAggrements.FINISH&quot;</span><span style=" font-family:'DejaVu Sans Mono'; color:#a9b7c6;">)<br /><br /><br /></span><span style=" font-family:'DejaVu Sans Mono'; color:#808080;">//возвращает список начислений по переданной позици договора и указанной цене<br /></span><span style=" font-family:'DejaVu Sans Mono'; color:#a9b7c6;">List&lt;Accrual&gt; calculateAccruals(Date from, Date to, Date billDate, ContractPosition position, BigDecimal price) {<br />    DatePeriodTools datePeriodTools = AppBeans.get(DatePeriodTools.</span><span style=" font-family:'DejaVu Sans Mono'; color:#cc7832;">class</span><span style=" font-family:'DejaVu Sans Mono'; color:#a9b7c6;">)<br />    CalculationWorkerHelper helper = AppBeans.get(CalculationWorkerHelper.</span><span style=" font-family:'DejaVu Sans Mono'; color:#cc7832;">class</span><span style=" font-family:'DejaVu Sans Mono'; color:#a9b7c6;">)<br />    from = from == </span><span style=" font-family:'DejaVu Sans Mono'; color:#cc7832;">null </span><span style=" font-family:'DejaVu Sans Mono'; color:#a9b7c6;">? </span><span style=" font-family:'DejaVu Sans Mono'; color:#cc7832;">new </span><span style=" font-family:'DejaVu Sans Mono'; color:#a9b7c6;">Date() : from<br />    to = to == </span><span style=" font-family:'DejaVu Sans Mono'; color:#cc7832;">null </span><span style=" font-family:'DejaVu Sans Mono'; color:#a9b7c6;">? from : to<br />    billDate = billDate == </span><span style=" font-family:'DejaVu Sans Mono'; color:#cc7832;">null </span><span style=" font-family:'DejaVu Sans Mono'; color:#a9b7c6;">? </span><span style=" font-family:'DejaVu Sans Mono'; color:#cc7832;">new </span><span style=" font-family:'DejaVu Sans Mono'; color:#a9b7c6;">Date() : billDate<br /><br />    List&lt;Accrual&gt; result = </span><span style=" font-family:'DejaVu Sans Mono'; color:#cc7832;">new </span><span style=" font-family:'DejaVu Sans Mono'; color:#a9b7c6;">ArrayList&lt;&gt;()<br /><br />    </span><span style=" font-family:'DejaVu Sans Mono'; color:#cc7832;">try </span><span style=" font-family:'DejaVu Sans Mono'; color:#a9b7c6;">{<br /><br />        Calendar calendarFrom = datePeriodTools.getFirstDayOfMonth(from)<br />        Calendar calendarTo = datePeriodTools.getFirstDayOfMonth(to)<br /><br />        </span><span style=" font-family:'DejaVu Sans Mono'; color:#cc7832;">while </span><span style=" font-family:'DejaVu Sans Mono'; color:#a9b7c6;">((calendarFrom.get(Calendar.YEAR) == calendarTo.get(Calendar.YEAR) &amp;&amp;<br />                calendarFrom.get(Calendar.MONTH) &lt;= calendarTo.get(Calendar.MONTH)) ||<br />                (calendarFrom.get(Calendar.YEAR) &lt; calendarTo.get(Calendar.YEAR))) {<br />            </span><span style=" font-family:'DejaVu Sans Mono'; color:#cc7832;">int </span><span style=" font-family:'DejaVu Sans Mono'; color:#a9b7c6;">documentNumber = helper.getNextAccrualNumber()<br />            Date period = calendarFrom.getTime()<br /><br />            Accrual accrual<br />            </span><span style=" font-family:'DejaVu Sans Mono'; color:#cc7832;">try </span><span style=" font-family:'DejaVu Sans Mono'; color:#a9b7c6;">{<br />                accrual = calculateAverage(position, period, documentNumber, billDate, price)<br />                </span><span style=" font-family:'DejaVu Sans Mono'; color:#cc7832;">if </span><span style=" font-family:'DejaVu Sans Mono'; color:#a9b7c6;">(accrual != </span><span style=" font-family:'DejaVu Sans Mono'; color:#cc7832;">null</span><span style=" font-family:'DejaVu Sans Mono'; color:#a9b7c6;">)<br />                    result.add(accrual)<br />            } </span><span style=" font-family:'DejaVu Sans Mono'; color:#cc7832;">catch </span><span style=" font-family:'DejaVu Sans Mono'; color:#a9b7c6;">(Exception e) {<br />                log.error(</span><span style=" font-family:'DejaVu Sans Mono'; color:#6a8759;">'не удалось создать начисление для ContractPosition: ' </span><span style=" font-family:'DejaVu Sans Mono'; color:#a9b7c6;">+ position.getId())<br />            }<br />            calendarFrom.add(Calendar.MONTH, </span><span style=" font-family:'DejaVu Sans Mono'; color:#6897bb;">1</span><span style=" font-family:'DejaVu Sans Mono'; color:#a9b7c6;">)<br />        }<br />    }<br />    </span><span style=" font-family:'DejaVu Sans Mono'; color:#cc7832;">finally </span><span style=" font-family:'DejaVu Sans Mono'; color:#a9b7c6;">{<br />        log.debug(</span><span style=" font-family:'DejaVu Sans Mono'; color:#6a8759;">'Расчет начислений окончен'</span><span style=" font-family:'DejaVu Sans Mono'; color:#a9b7c6;">)<br />    }<br />    </span><span style=" font-family:'DejaVu Sans Mono'; color:#cc7832;">return </span><span style=" font-family:'DejaVu Sans Mono'; color:#a9b7c6;">result<br />}<br /><br /></span><span style=" font-family:'DejaVu Sans Mono'; color:#808080;">//расчет по-среднему<br /></span><span style=" font-family:'DejaVu Sans Mono'; color:#a9b7c6;">Accrual calculateAverage(ContractPosition position, Date period, </span><span style=" font-family:'DejaVu Sans Mono'; color:#cc7832;">int </span><span style=" font-family:'DejaVu Sans Mono'; color:#a9b7c6;">documentNumber, Date billDate, BigDecimal price) {<br />    CalculationWorkerHelper helper = AppBeans.get(CalculationWorkerHelper.</span><span style=" font-family:'DejaVu Sans Mono'; color:#cc7832;">class</span><span style=" font-family:'DejaVu Sans Mono'; color:#a9b7c6;">)<br /><br />    BigDecimal norm<br />    </span><span style=" font-family:'DejaVu Sans Mono'; color:#cc7832;">if </span><span style=" font-family:'DejaVu Sans Mono'; color:#a9b7c6;">(position.getVolumeYear() != </span><span style=" font-family:'DejaVu Sans Mono'; color:#cc7832;">null </span><span style=" font-family:'DejaVu Sans Mono'; color:#a9b7c6;">&amp;&amp; position.getVolumeYear() != BigDecimal.ZERO)<br />        norm = helper.divide(position.getVolumeYear(), BigDecimal.valueOf(</span><span style=" font-family:'DejaVu Sans Mono'; color:#6897bb;">12</span><span style=" font-family:'DejaVu Sans Mono'; color:#a9b7c6;">))<br /><br />    BigDecimal tariff = price<br />    tariff = helper.addNdsTo(tariff)<br /><br />    BigDecimal sum = helper.multiply(norm, tariff)<br />    BigDecimal totalSum = sum<br />    BigDecimal ndsSum = helper.getNdsFrom(sum)<br />    </span><span style=" font-family:'DejaVu Sans Mono'; color:#808080;">//a.kotvinskiy Объем ТКО в месяц<br />    </span><span style=" font-family:'DejaVu Sans Mono'; color:#a9b7c6;">BigDecimal amountBase = position.getVolumeYear()/</span><span style=" font-family:'DejaVu Sans Mono'; color:#6897bb;">12<br /><br />    </span><span style=" font-family:'DejaVu Sans Mono'; color:#a9b7c6;">Accrual accrual = </span><span style=" font-family:'DejaVu Sans Mono'; color:#cc7832;">new </span><span style=" font-family:'DejaVu Sans Mono'; color:#a9b7c6;">Accrual()<br />    accrual.setContractPosition(position)<br />    accrual.setPeriod(period)<br />    accrual.setContragent(position.getContragent())<br />    accrual.setAmount(norm)<br />    </span><span style=" font-family:'DejaVu Sans Mono'; color:#808080;">//a.kotvinskiy /--<br />    // Недостающие атрибуты<br />    </span><span style=" font-family:'DejaVu Sans Mono'; color:#a9b7c6;">accrual.setAmountBase(amountBase)<br />    accrual.setTotalSumBase(totalSum)<br />    accrual.setNdsSumBase(totalSum-price.multiply(amountBase))<br />    </span><span style=" font-family:'DejaVu Sans Mono'; color:#808080;">//a.kotvinskiy --/<br />    </span><span style=" font-family:'DejaVu Sans Mono'; color:#a9b7c6;">accrual.setPrice(tariff)<br />    accrual.setReductionFactor(BigDecimal.ONE)<br />    accrual.setZoneRatio(BigDecimal.ONE)<br />    accrual.setNds(BigDecimal.valueOf(</span><span style=" font-family:'DejaVu Sans Mono'; color:#6897bb;">20</span><span style=" font-family:'DejaVu Sans Mono'; color:#a9b7c6;">))<br />    accrual.setSum(sum)<br />    accrual.setTotalSum(totalSum)<br />    accrual.setNdsSum(ndsSum)<br />    accrual.setComment(</span><span style=" font-family:'DejaVu Sans Mono'; color:#6a8759;">'По-среднему'</span><span style=" font-family:'DejaVu Sans Mono'; color:#a9b7c6;">)<br />    accrual.setDebugComment(</span><span style=" font-family:'DejaVu Sans Mono'; color:#6a8759;">''</span><span style=" font-family:'DejaVu Sans Mono'; color:#a9b7c6;">)<br />    accrual.setDocumentNumber(documentNumber)<br />    accrual.setDocumentDate(billDate)<br /><br />    </span><span style=" font-family:'DejaVu Sans Mono'; color:#cc7832;">return </span><span style=" font-family:'DejaVu Sans Mono'; color:#a9b7c6;">accrual<br />}</span></p></body></html>
