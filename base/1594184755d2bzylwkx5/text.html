<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0//EN" "http://www.w3.org/TR/REC-html40/strict.dtd">
<html><head><meta name="qrichtext" content="1" /><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><style type="text/css">
p, li { white-space: pre-wrap; }
</style></head><body style=" font-family:'DejaVu Sans'; font-size:11pt; font-weight:400; font-style:normal;">
<pre style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#2b2b2b;"><span style=" font-family:'DejaVu Sans Mono'; color:#808080;">//construct entity view from already loaded entity<br /></span><span style=" font-family:'DejaVu Sans Mono'; color:#cc7832;">private </span><span style=" font-family:'DejaVu Sans Mono'; color:#a9b7c6;">View </span><span style=" font-family:'DejaVu Sans Mono'; color:#ffc66d;">getView</span><span style=" font-family:'DejaVu Sans Mono'; color:#a9b7c6;">(Entity entity) {<br />    </span><span style=" font-family:'DejaVu Sans Mono'; color:#cc7832;">return </span><span style=" font-family:'DejaVu Sans Mono'; color:#a9b7c6;">getView(entity</span><span style=" font-family:'DejaVu Sans Mono'; color:#cc7832;">, new </span><span style=" font-family:'DejaVu Sans Mono'; color:#a9b7c6;">HashSet&lt;&gt;())</span><span style=" font-family:'DejaVu Sans Mono'; color:#cc7832;">;<br /></span><span style=" font-family:'DejaVu Sans Mono'; color:#a9b7c6;">}<br /><br /></span><span style=" font-family:'DejaVu Sans Mono'; color:#cc7832;">private </span><span style=" font-family:'DejaVu Sans Mono'; color:#a9b7c6;">View </span><span style=" font-family:'DejaVu Sans Mono'; color:#ffc66d;">getView</span><span style=" font-family:'DejaVu Sans Mono'; color:#a9b7c6;">(Entity entity</span><span style=" font-family:'DejaVu Sans Mono'; color:#cc7832;">, </span><span style=" font-family:'DejaVu Sans Mono'; color:#a9b7c6;">Set&lt;String&gt; visitedProperties) {<br />    View view = </span><span style=" font-family:'DejaVu Sans Mono'; color:#cc7832;">new </span><span style=" font-family:'DejaVu Sans Mono'; color:#a9b7c6;">View(entity.getClass())</span><span style=" font-family:'DejaVu Sans Mono'; color:#cc7832;">;<br />    for </span><span style=" font-family:'DejaVu Sans Mono'; color:#a9b7c6;">(MetaProperty property : </span><span style=" font-family:'DejaVu Sans Mono'; color:#9876aa;">metadata</span><span style=" font-family:'DejaVu Sans Mono'; color:#a9b7c6;">.getClassNN(entity.getClass()).getProperties()) {<br />        </span><span style=" font-family:'DejaVu Sans Mono'; color:#cc7832;">if </span><span style=" font-family:'DejaVu Sans Mono'; color:#a9b7c6;">(!PersistenceHelper.</span><span style=" font-family:'DejaVu Sans Mono'; font-style:italic; color:#a9b7c6;">isLoaded</span><span style=" font-family:'DejaVu Sans Mono'; color:#a9b7c6;">(entity</span><span style=" font-family:'DejaVu Sans Mono'; color:#cc7832;">, </span><span style=" font-family:'DejaVu Sans Mono'; color:#a9b7c6;">property.getName()) || !</span><span style=" font-family:'DejaVu Sans Mono'; color:#9876aa;">metadata</span><span style=" font-family:'DejaVu Sans Mono'; color:#a9b7c6;">.getTools().isPersistent(property)) {<br />            </span><span style=" font-family:'DejaVu Sans Mono'; color:#cc7832;">continue;<br />        </span><span style=" font-family:'DejaVu Sans Mono'; color:#a9b7c6;">}<br />        String propertyAddress = entity.getClass().getName() + </span><span style=" font-family:'DejaVu Sans Mono'; color:#6a8759;">&quot;.&quot; </span><span style=" font-family:'DejaVu Sans Mono'; color:#a9b7c6;">+ property.getName()</span><span style=" font-family:'DejaVu Sans Mono'; color:#cc7832;">;<br />        </span><span style=" font-family:'DejaVu Sans Mono'; color:#a9b7c6;">String reversePropertyAddress = </span><span style=" font-family:'DejaVu Sans Mono'; color:#cc7832;">null;<br />        if </span><span style=" font-family:'DejaVu Sans Mono'; color:#a9b7c6;">(property.getInverse() != </span><span style=" font-family:'DejaVu Sans Mono'; color:#cc7832;">null</span><span style=" font-family:'DejaVu Sans Mono'; color:#a9b7c6;">) {<br />            reversePropertyAddress = property.getInverse().getDomain().getJavaClass().getName() + </span><span style=" font-family:'DejaVu Sans Mono'; color:#6a8759;">&quot;.&quot; </span><span style=" font-family:'DejaVu Sans Mono'; color:#a9b7c6;">+ property.getInverse().getName()</span><span style=" font-family:'DejaVu Sans Mono'; color:#cc7832;">;<br />        </span><span style=" font-family:'DejaVu Sans Mono'; color:#a9b7c6;">}<br />        </span><span style=" font-family:'DejaVu Sans Mono'; color:#cc7832;">if </span><span style=" font-family:'DejaVu Sans Mono'; color:#a9b7c6;">(visitedProperties.contains(propertyAddress) || visitedProperties.contains(reversePropertyAddress)) {</span><span style=" font-family:'DejaVu Sans Mono'; color:#808080;">//prevent loop specify it as local<br />            </span><span style=" font-family:'DejaVu Sans Mono'; color:#cc7832;">if </span><span style=" font-family:'DejaVu Sans Mono'; color:#a9b7c6;">(property.getRange().isClass()) {<br />                view.addProperty(property.getName()</span><span style=" font-family:'DejaVu Sans Mono'; color:#cc7832;">, </span><span style=" font-family:'DejaVu Sans Mono'; color:#9876aa;">viewRepository</span><span style=" font-family:'DejaVu Sans Mono'; color:#a9b7c6;">.getView(property.getRange().asClass()</span><span style=" font-family:'DejaVu Sans Mono'; color:#cc7832;">, </span><span style=" font-family:'DejaVu Sans Mono'; color:#a9b7c6;">View.</span><span style=" font-family:'DejaVu Sans Mono'; font-style:italic; color:#9876aa;">LOCAL</span><span style=" font-family:'DejaVu Sans Mono'; color:#a9b7c6;">))</span><span style=" font-family:'DejaVu Sans Mono'; color:#cc7832;">;<br />                continue;<br />            </span><span style=" font-family:'DejaVu Sans Mono'; color:#a9b7c6;">}<br />        }<br />        visitedProperties.add(propertyAddress)</span><span style=" font-family:'DejaVu Sans Mono'; color:#cc7832;">;<br /><br />        if </span><span style=" font-family:'DejaVu Sans Mono'; color:#a9b7c6;">(property.getRange().isClass()) {<br />            Object value = entity.getValue(property.getName())</span><span style=" font-family:'DejaVu Sans Mono'; color:#cc7832;">;<br />            if </span><span style=" font-family:'DejaVu Sans Mono'; color:#a9b7c6;">(value </span><span style=" font-family:'DejaVu Sans Mono'; color:#cc7832;">instanceof </span><span style=" font-family:'DejaVu Sans Mono'; color:#a9b7c6;">Collection) {<br />                </span><span style=" font-family:'DejaVu Sans Mono'; color:#cc7832;">for </span><span style=" font-family:'DejaVu Sans Mono'; color:#a9b7c6;">(Object item : (Collection) value) {<br />                    </span><span style=" font-family:'DejaVu Sans Mono'; color:#cc7832;">if </span><span style=" font-family:'DejaVu Sans Mono'; color:#a9b7c6;">(item != </span><span style=" font-family:'DejaVu Sans Mono'; color:#cc7832;">null</span><span style=" font-family:'DejaVu Sans Mono'; color:#a9b7c6;">) {<br />                        value = item</span><span style=" font-family:'DejaVu Sans Mono'; color:#cc7832;">;<br />                        break;<br />                    </span><span style=" font-family:'DejaVu Sans Mono'; color:#a9b7c6;">}<br />                }<br />            }<br />            </span><span style=" font-family:'DejaVu Sans Mono'; color:#cc7832;">if </span><span style=" font-family:'DejaVu Sans Mono'; color:#a9b7c6;">(value == </span><span style=" font-family:'DejaVu Sans Mono'; color:#cc7832;">null </span><span style=" font-family:'DejaVu Sans Mono'; color:#a9b7c6;">|| value </span><span style=" font-family:'DejaVu Sans Mono'; color:#cc7832;">instanceof </span><span style=" font-family:'DejaVu Sans Mono'; color:#a9b7c6;">Collection) {<br />                view.addProperty(property.getName()</span><span style=" font-family:'DejaVu Sans Mono'; color:#cc7832;">, </span><span style=" font-family:'DejaVu Sans Mono'; color:#9876aa;">viewRepository</span><span style=" font-family:'DejaVu Sans Mono'; color:#a9b7c6;">.getView(property.getRange().asClass()</span><span style=" font-family:'DejaVu Sans Mono'; color:#cc7832;">, </span><span style=" font-family:'DejaVu Sans Mono'; color:#a9b7c6;">View.</span><span style=" font-family:'DejaVu Sans Mono'; font-style:italic; color:#9876aa;">LOCAL</span><span style=" font-family:'DejaVu Sans Mono'; color:#a9b7c6;">))</span><span style=" font-family:'DejaVu Sans Mono'; color:#cc7832;">;<br />            </span><span style=" font-family:'DejaVu Sans Mono'; color:#a9b7c6;">} </span><span style=" font-family:'DejaVu Sans Mono'; color:#cc7832;">else </span><span style=" font-family:'DejaVu Sans Mono'; color:#a9b7c6;">{<br />                view.addProperty(property.getName()</span><span style=" font-family:'DejaVu Sans Mono'; color:#cc7832;">, </span><span style=" font-family:'DejaVu Sans Mono'; color:#a9b7c6;">getView((Entity) value</span><span style=" font-family:'DejaVu Sans Mono'; color:#cc7832;">, </span><span style=" font-family:'DejaVu Sans Mono'; color:#a9b7c6;">visitedProperties))</span><span style=" font-family:'DejaVu Sans Mono'; color:#cc7832;">;<br />            </span><span style=" font-family:'DejaVu Sans Mono'; color:#a9b7c6;">}<br />        } </span><span style=" font-family:'DejaVu Sans Mono'; color:#cc7832;">else </span><span style=" font-family:'DejaVu Sans Mono'; color:#a9b7c6;">{<br />            view.addProperty(property.getName())</span><span style=" font-family:'DejaVu Sans Mono'; color:#cc7832;">;<br />        </span><span style=" font-family:'DejaVu Sans Mono'; color:#a9b7c6;">}<br />    }<br />    </span><span style=" font-family:'DejaVu Sans Mono'; color:#cc7832;">return </span><span style=" font-family:'DejaVu Sans Mono'; color:#a9b7c6;">view</span><span style=" font-family:'DejaVu Sans Mono'; color:#cc7832;">;<br /></span><span style=" font-family:'DejaVu Sans Mono'; color:#a9b7c6;">}</span></pre></body></html>