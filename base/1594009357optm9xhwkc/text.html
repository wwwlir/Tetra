<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0//EN" "http://www.w3.org/TR/REC-html40/strict.dtd">
<html><head><meta name="qrichtext" content="1" /><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><style type="text/css">
p, li { white-space: pre-wrap; }
</style></head><body style=" font-family:'DejaVu Sans'; font-size:11pt; font-weight:400; font-style:normal;">
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Lato Heavy'; font-size:12pt; color:#062d91;">import com.groupstp.rtneo.entity.*</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Lato Heavy'; font-size:12pt; color:#062d91;">import com.haulmont.cuba.core.global.*</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Lato Heavy'; font-size:12pt; color:#062d91;">import com.groupstp.rtneo.service.BillService</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Lato Heavy'; font-size:12pt; color:#062d91;">import java.text.SimpleDateFormat</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Lato Heavy'; font-size:12pt; color:#062d91;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Lato Heavy'; font-size:12pt; color:#062d91;">DataManager dataManager = AppBeans.get(DataManager.NAME)</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Lato Heavy'; font-size:12pt; color:#062d91;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Lato Heavy'; font-size:12pt; color:#062d91;">def i = 0</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Lato Heavy'; font-size:12pt; color:#062d91;">log.debug(new Date())</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Lato Heavy'; font-size:12pt; color:#062d91;">def contragents = dataManager.load(Contragent.class)</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Lato Heavy'; font-size:12pt; color:#062d91;">        .query('select c from rtneo$Contragent c where c.type = 3 and (select count(cre) from rtneo$ContragentRealEstate cre where c.id = cre.contragent.id and (not cre.category.isLiving = true or cre.category.isLiving is null))&gt;0 and (select count(ct) from rtneo$Contract ct where ct.contragent.id = c.id and ct.accepted = true)&gt;1 and (select count(p) from rtneo$Payment p where p.inn = c.inn)&gt;0')</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Lato Heavy'; font-size:12pt; color:#062d91;">        .view(&quot;_local&quot;)</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Lato Heavy'; font-size:12pt; color:#062d91;">        .list()</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Lato Heavy'; font-size:12pt; color:#062d91;">log.debug(&quot;Contragents size ${contragents.size()}&quot;)</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Lato Heavy'; font-size:12pt; color:#062d91;">log.debug(new Date())</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Lato Heavy'; font-size:12pt; color:#062d91;">for(def contragent : contragents){</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Lato Heavy'; font-size:12pt; color:#062d91;">    </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Lato Heavy'; font-size:12pt; color:#062d91;">    List&lt;Accrual&gt; accruals = getContragentBills(contragent.getId())</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Lato Heavy'; font-size:12pt; color:#062d91;">    def sum = 0;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Lato Heavy'; font-size:12pt; color:#062d91;">    for(Accrual accrual : accruals){</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Lato Heavy'; font-size:12pt; color:#062d91;">        sum += accrual.getTotalSum()</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Lato Heavy'; font-size:12pt; color:#062d91;">    }</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Lato Heavy'; font-size:12pt; color:#062d91;">    </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Lato Heavy'; font-size:12pt; color:#062d91;">    def payments = dataManager.load(Payment.class)</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Lato Heavy'; font-size:12pt; color:#062d91;">            .query('select p from rtneo$Payment p where p.inn = :inn')</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Lato Heavy'; font-size:12pt; color:#062d91;">            .parameter(&quot;inn&quot;, contragent.getInn())</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Lato Heavy'; font-size:12pt; color:#062d91;">            .view(&quot;_local&quot;)</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Lato Heavy'; font-size:12pt; color:#062d91;">            .list()</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Lato Heavy'; font-size:12pt; color:#062d91;">    def pay = 0;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Lato Heavy'; font-size:12pt; color:#062d91;">    for(Payment payment : payments){</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Lato Heavy'; font-size:12pt; color:#062d91;">        pay += payment.getSum()</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Lato Heavy'; font-size:12pt; color:#062d91;">    }</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Lato Heavy'; font-size:12pt; color:#062d91;">    log.debug(&quot;!${contragent.getName()}!${contragent.getInn()}!${contragent.getPersonalAccount()}!${sum}!${pay}!${sum-pay}&quot;)</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Lato Heavy'; font-size:12pt; color:#062d91;">}</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Lato Heavy'; font-size:12pt; color:#062d91;">log.debug(new Date())</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Lato Heavy'; font-size:12pt; color:#062d91;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Lato Heavy'; font-size:12pt; color:#062d91;">List&lt;Accrual&gt; getContragentBills(UUID contragentID) {</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Lato Heavy'; font-size:12pt; color:#062d91;">        String sqlQuery = 'select e from rtneo$Accrual e where 1=0';</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Lato Heavy'; font-size:12pt; color:#062d91;">        </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Lato Heavy'; font-size:12pt; color:#062d91;">        List&lt;Accrual&gt; accruals = new ArrayList&lt;Accrual&gt;();</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Lato Heavy'; font-size:12pt; color:#062d91;">        </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Lato Heavy'; font-size:12pt; color:#062d91;">        List&lt;Contract&gt; contracts = dataManager.load(Contract.class)</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Lato Heavy'; font-size:12pt; color:#062d91;">                .query('select e from rtneo$Contract e where e.contragent.id = :contragent and e.accepted = true order by e.createTs desc')</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Lato Heavy'; font-size:12pt; color:#062d91;">                .parameter(&quot;contragent&quot;, contragentID)</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Lato Heavy'; font-size:12pt; color:#062d91;">                .view(&quot;_base&quot;)</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Lato Heavy'; font-size:12pt; color:#062d91;">                .list();</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Lato Heavy'; font-size:12pt; color:#062d91;">                </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Lato Heavy'; font-size:12pt; color:#062d91;">        if (contracts.size() &gt; 0) {</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Lato Heavy'; font-size:12pt; color:#062d91;">            SimpleDateFormat sdf = new SimpleDateFormat(&quot;yyyy-MM-dd&quot;);</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Lato Heavy'; font-size:12pt; color:#062d91;">            Contract lastContract = null;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Lato Heavy'; font-size:12pt; color:#062d91;">            for (Contract contract : contracts) {</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Lato Heavy'; font-size:12pt; color:#062d91;">                if (lastContract == null) {</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Lato Heavy'; font-size:12pt; color:#062d91;">                    lastContract = contract;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Lato Heavy'; font-size:12pt; color:#062d91;">                    sqlQuery = &quot;cast(a.contractPosition.contract.id text)='&quot; + contract.getId().toString() + &quot;' &quot;;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Lato Heavy'; font-size:12pt; color:#062d91;">                } else {</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Lato Heavy'; font-size:12pt; color:#062d91;">                    if (contract.getFrom().before(lastContract.getFrom())) {</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Lato Heavy'; font-size:12pt; color:#062d91;">                        sqlQuery = sqlQuery + &quot; or (cast(a.contractPosition.contract.id text)='&quot; + contract.getId().toString() + &quot;' and a.period &lt; '&quot; + sdf.format(lastContract.getFrom()) + &quot;' )&quot;;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Lato Heavy'; font-size:12pt; color:#062d91;">                        lastContract = contract;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Lato Heavy'; font-size:12pt; color:#062d91;">                    }</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Lato Heavy'; font-size:12pt; color:#062d91;">                }</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Lato Heavy'; font-size:12pt; color:#062d91;">            }</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Lato Heavy'; font-size:12pt; color:#062d91;">            sqlQuery = 'select a from  rtneo$Accrual a where a.contragent.id = :contragentID and  (' + sqlQuery + ')  order by a.period';</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Lato Heavy'; font-size:12pt; color:#062d91;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Lato Heavy'; font-size:12pt; color:#062d91;">            accruals = dataManager.load(Accrual.class)</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Lato Heavy'; font-size:12pt; color:#062d91;">                    .query(sqlQuery)</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Lato Heavy'; font-size:12pt; color:#062d91;">                    .parameter(&quot;contragentID&quot;, contragentID)</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Lato Heavy'; font-size:12pt; color:#062d91;">                    .view(&quot;_local&quot;)</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Lato Heavy'; font-size:12pt; color:#062d91;">                    .list();</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Lato Heavy'; font-size:12pt; color:#062d91;">        }</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Lato Heavy'; font-size:12pt; color:#062d91;">        return accruals;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:20px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Lato Heavy'; font-size:12pt; color:#062d91;">    }</span></p></body></html>